<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5ع5 - حجز الملاعب</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap');
        
        :root {
            --primary-color: #10B981;
            --secondary-color: #3B82F6;
            --background-color: #f0f4f8;
            --text-color: #2c3e50;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        .animate-scale-in-up {
            animation: scaleInUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        
        .animate-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scaleInUp {
            from { transform: translateY(30px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }

        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f0f4f8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #aab8c2;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #8899a6;
        }

        /* Custom radio card for a better UX */
        .radio-card {
            display: flex;
            align-items: center;
            padding: 1.25rem;
            border-radius: 1rem;
            background-color: white;
            border: 2px solid #e5e7eb;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            position: relative;
            /* Fix for text overlap on mobile: Ensure min-height and proper wrapping */
            min-height: 100px;
            text-align: right;
        }
        .radio-card:hover,
        .radio-card.selected {
            border-color: var(--primary-color);
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .radio-card input[type="radio"] {
            display: none;
        }
        .radio-card input[type="radio"]:checked + .checkmark {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .radio-card input[type="radio"]:checked + .checkmark::after {
            transform: scale(1);
            opacity: 1;
        }
        .checkmark {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            border: 2px solid #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-left: 1rem;
            flex-shrink: 0;
            background-color: #f9fafb;
            transition: all 0.2s ease-in-out;
        }
        .checkmark::after {
            content: '';
            width: 0.75rem;
            height: 0.75rem;
            background-color: white;
            border-radius: 50%;
            transform: scale(0);
            opacity: 0;
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }
        .radio-card-icon {
            font-size: 1.5rem;
            color: #4b5563;
            margin-left: 1rem;
        }
        .radio-card.selected .radio-card-icon {
            color: var(--primary-color);
        }
        .radio-card-price {
            position: absolute;
            top: 1rem;
            left: 1rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: #3b82f6;
        }

        /* Modal Animation Classes */
        .modal {
            transition: all 0.3s ease-out;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            transform: scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .modal:not(.hidden) .modal-content {
            transform: scale(1);
        }

        /* Custom alert styles */
        .custom-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideInDown 0.4s ease-out;
        }

        .custom-alert.success {
            background-color: #D1FAE5;
            color: #065F46;
        }
        .custom-alert.error {
            background-color: #FEE2E2;
            color: #991B1B;
        }
        @keyframes slideInDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Button hover effects */
        .btn-hover-effect:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        .btn-hover-effect:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* Mobile specific adjustments for modal text */
        @media (max-width: 640px) {
            .radio-card .text-xl {
                font-size: 1.1rem; /* Slightly smaller title font */
            }
            .radio-card .text-sm {
                font-size: 0.75rem; /* Smaller description font */
            }
            .radio-card-price {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Global Header Placeholder -->
    <div id="global-header"></div>

    <!-- Hero Section -->
    <section class="relative text-white py-28 text-center shadow-2xl overflow-hidden bg-cover bg-center" style="background-image: url('images/hero.jpg');">
        <div class="absolute inset-0 bg-black opacity-50"></div>
        <div class="container mx-auto px-6 relative z-10">
            <h2 class="text-5xl md:text-7xl font-extrabold mb-6 leading-tight drop-shadow-lg animate-fade-in">
                احجز ملعبك <span class="text-yellow-200">الأفضل</span> الآن!
            </h2>
            <p class="text-xl md:text-3xl mb-10 opacity-95 drop-shadow animate-fade-in delay-100">
                اكتشف أرقى الملاعب، احجز بكل سهولة، وشارك اللعب مع مجتمعنا.
            </p>
            <button
                onclick="document.getElementById('fields-section').scrollIntoView({ behavior: 'smooth' })"
                class="bg-white text-green-700 font-bold px-10 py-5 rounded-full shadow-2xl hover:bg-gray-100 transform hover:scale-105 transition-all duration-300 text-lg animate-fade-in delay-200 btn-hover-effect"
            >
                استكشف الملاعب
                <i class="fa-solid fa-arrow-down mr-2"></i>
            </button>
        </div>
    </section>

    <!-- Fields Section -->
    <main class="flex-grow container mx-auto px-6 py-20">
        <section id="fields-section">
            <h3 class="text-5xl font-extrabold text-center mb-16 text-gray-900 leading-tight">
                ملاعبنا <span class="text-green-600">المختارة</span> بعناية
            </h3>
            <div id="fields-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-10">
                <!-- Fields will be injected here by JavaScript -->
            </div>
        </section>
    </main>

    <!-- Main Modal (for all steps) -->
    <div id="main-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 animate-fade-in">
        <div class="bg-white rounded-2xl shadow-3xl w-full max-w-lg relative p-8 animate-scale-in-up border-b-4 border-green-600 max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors duration-300 rounded-full bg-gray-100 p-2 hover:bg-gray-200">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div id="modal-content-container">
                <!-- Content will be injected here dynamically -->
            </div>
        </div>
    </div>

    <!-- Matchmaking Modal -->
    <div id="matchmaking-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 animate-fade-in">
        <div class="bg-white rounded-2xl shadow-3xl w-full max-w-lg relative p-8 animate-scale-in-up border-b-4 border-blue-600 max-h-[90vh] overflow-y-auto">
            <button onclick="closeMatchmakingModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors duration-300 rounded-full bg-gray-100 p-2 hover:bg-gray-200">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div id="matchmaking-content-container">
                <!-- Content will be injected here dynamically -->
            </div>
        </div>
    </div>

    <!-- Message Box (replaces alert) -->
    <div id="message-box" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-3xl p-8 w-full max-w-sm relative text-center border-t-4 border-red-500">
            <h4 id="message-box-title" class="text-2xl font-bold mb-4 text-gray-900 flex items-center justify-center gap-2"></h4>
            <p id="message-box-content" class="text-gray-700 mb-6 text-lg"></p>
            <button onclick="closeMessageBox()" class="bg-red-600 text-white px-7 py-3 rounded-xl hover:bg-red-700 transition-all duration-300 shadow-md text-lg">
                حسناً
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-200 py-10 mt-auto">
        <div class="container mx-auto px-6 text-center">
            <!-- Logo centered -->
            <div class="mb-6">
                <img src="images/logo.jpg" alt="5ع5 Logo" class="mx-auto h-16 w-auto rounded-lg">
            </div>
            <!-- Copyright text -->
            <p class="mb-4 text-lg">© 2025 جميع الحقوق محفوظة.</p>
            <!-- Terms of Use link -->
            <div class="text-md">
                <a href="terms-of-use.html" class="text-gray-400 hover:text-white transition-colors duration-300">شروط الاستخدام</a>
            </div>
        </div>
    </footer>

    <script src="header.js"></script>
    <script>
        let selectedField = null;
        let selectedFieldData = null;
        let selectedReservationType = null;
        let selectedDate = null;
        let selectedSlotId = null;
        let selectedSlotData = null;
        let selectedPlayerCount = null;
        let reservationFlow = null; // 'direct_reservation' or 'matchmaking_request'

        // Get user details from localStorage
        const loggedInUserId = localStorage.getItem('userId');
        const loggedInUserName = localStorage.getItem('userName');
        const loggedInUserEmail = localStorage.getItem('userEmail');
        
        // --- UPDATED BOOKING TYPES BASED ON USER INSTRUCTIONS ---
        const bookingTypes = {
            // 1- 2 teams ready: Min 6 per team (Total 12)
            two_teams_ready: {
                min: 12,
                max: null, // No max limit specified, using null to indicate open-ended
                label: 'فريقان جاهزان - حجز ملعب كامل',
                description: 'لديك فريقان كاملان (6 لاعبين فأكثر لكل فريق) - حجز مؤكد',
                flow: 'team_join_booking', // Leads to team-join page, ends in Confirmed Booking
                min_per_team: 6
            },
            // 2- team looking for another team: Min 6, no max
            team_vs_team: {
                min: 6,
                max: null, 
                label: 'فريق يبحث عن فريق آخر',
                description: 'لديك فريق (6 لاعبين فأكثر) وتبحث عن منافس',
                flow: 'team_join_matchmaking', // Leads to team-join page, ends in Matchmaking Request
                min_per_team: 6
            },
            // 3- team looking for players: Min 3, Max 5
            team_looking_for_players: {
                min: 3,
                max: 5,
                label: 'فريق يبحث عن لاعبين',
                description: 'فريقك غير مكتمل ويحتاج المزيد من اللاعبين (3-5 لاعبين)',
                flow: 'team_join_matchmaking', // Leads to team-join page, ends in Matchmaking Request
                min_per_team: 3
            },
            // 4- player looking for a team: Single player only
            players_looking_for_team: {
                min: 1,
                max: 1,
                label: 'لاعب يبحث عن فريق',
                description: 'لاعب واحد يريد الانضمام لفريق موجود - إرسال طلب مباشرة',
                flow: 'matchmaking_request' // Direct Matchmaking Request - No team-join page needed
            }
        };

        // --- Utility Functions for Modals (Unchanged) ---
        function showMessageBox(title, content, type = 'error') {
            const msgBox = document.getElementById('message-box');
            const msgTitle = document.getElementById('message-box-title');
            const msgContent = document.getElementById('message-box-content');
            const msgButton = msgBox.querySelector('button');

            msgTitle.innerHTML = '';
            msgBox.querySelector('.bg-white').classList.remove('border-t-4', 'border-red-500', 'border-green-600', 'border-yellow-500', 'border-blue-500');

            let icon, color, buttonClass, buttonText;
            switch(type) {
                case 'error':
                    icon = `<i class="fa-solid fa-octagon-xmark text-red-500 ml-2"></i>`;
                    color = 'red';
                    buttonClass = 'bg-red-600 text-white';
                    buttonText = 'حسناً';
                    break;
                case 'success':
                    icon = `<i class="fa-solid fa-circle-check text-green-600 ml-2"></i>`;
                    color = 'green';
                    buttonClass = 'bg-green-600 text-white';
                    buttonText = 'رائع!';
                    break;
                case 'warning':
                    icon = `<i class="fa-solid fa-triangle-exclamation text-yellow-500 ml-2"></i>`;
                    color = 'yellow';
                    buttonClass = 'bg-yellow-600 text-white';
                    buttonText = 'حسناً';
                    break;
                case 'info':
                    icon = `<i class="fa-solid fa-circle-info text-blue-500 ml-2"></i>`;
                    color = 'blue';
                    buttonClass = 'bg-blue-600 text-white';
                    buttonText = 'حسناً';
                    break;
            }

            msgTitle.innerHTML = `${icon}${title}`;
            msgBox.querySelector('.bg-white').classList.add(`border-t-4`, `border-${color}-500`);
            msgButton.className = `${buttonClass} px-7 py-3 rounded-xl hover:bg-${color}-700 transition-all duration-300 shadow-md text-lg`;
            msgButton.textContent = buttonText;
            msgContent.innerText = content;
            
            msgBox.classList.remove('hidden');
        }

        function closeMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
        }
        
        function showCustomAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `custom-alert ${type}`;
            alert.innerHTML = `
                <i class="fa-solid fa-circle-check"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(alert);

            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transform = 'translateX(-50%) translateY(-100%)';
                setTimeout(() => alert.remove(), 400);
            }, 3000);
        }

        // --- Main Modal Functions ---
        async function openModal(step, fieldId = null) {
            const modal = document.getElementById('main-modal');
            const contentContainer = document.getElementById('modal-content-container');
            
            // Show modal with smooth animation
            modal.classList.remove('hidden');
            
            // Show loading state while processing
            contentContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center py-16">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-green-600 mb-6"></div>
                    <h4 class="text-2xl font-bold text-gray-900 mb-2">جاري التحميل...</h4>
                    <p class="text-gray-600 text-center">يرجى الانتظار</p>
                </div>
            `;

            if (step === 'field-details') {
                if (!loggedInUserId) {
                    closeModal();
                    showMessageBox(
                        'تسجيل الدخول مطلوب',
                        'للمتابعة، يرجى تسجيل الدخول أو إنشاء حساب جديد.',
                        'warning'
                    );
                    // Do not redirect, just show the warning
                    // setTimeout(() => window.location.href = 'auth.html', 2000); 
                    return;
                }
                
                selectedField = fieldId;
                
                try {
                    const response = await fetch(`/api/fields/${fieldId}?userId=${loggedInUserId}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    if (!data.field) throw new Error("Field data not found.");
                    
                    selectedFieldData = data.field;
                    renderReservationChoices();
                } catch (error) {
                    console.error('Failed to fetch field details:', error);
                    renderErrorState(contentContainer, 'فشل في تحميل تفاصيل الملعب', 'حدث خطأ في الاتصال بالخادم');
                }
            } else if (step === 'availability') {
                renderAvailabilityModal();
            } else if (step === 'confirm') {
                // This step is no longer used directly here, handled by team-join.html or direct submit
                // renderConfirmationStep(); 
            }
        }

        function closeModal() {
            document.getElementById('main-modal').classList.add('hidden');
            document.getElementById('modal-content-container').innerHTML = '';
            selectedField = null;
            selectedFieldData = null;
            selectedReservationType = null;
            selectedDate = null;
            selectedSlotId = null;
            selectedSlotData = null;
            selectedPlayerCount = null;
            reservationFlow = null;
        }

        function closeMatchmakingModal() {
            document.getElementById('matchmaking-modal').classList.add('hidden');
            document.getElementById('matchmaking-content-container').innerHTML = '';
        }

        function renderErrorState(container, title, message, retryCallback = null) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fa-solid fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <h4 class="text-2xl font-bold text-gray-900 mb-2">${title}</h4>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <div class="space-y-3">
                        ${retryCallback ? `<button onclick="${retryCallback}" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors w-full btn-hover-effect"><i class="fa-solid fa-refresh ml-2"></i> إعادة المحاولة</button>` : ''}
                        <button onclick="closeModal()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors w-full btn-hover-effect"><i class="fa-solid fa-times ml-2"></i> إغلاق</button>
                    </div>
                </div>
            `;
        }
        
        // Step 1: Choose reservation type
        function renderReservationChoices() {
            const contentContainer = document.getElementById('modal-content-container');
            // Determine price reference for 'two_teams_ready' (full field price)
            const priceForFullField = selectedFieldData.price_per_hour * 2; // Assuming 2 hours if not specified, or just the hourly price for display
            
            const choicesHtml = Object.entries(bookingTypes).map(([key, value]) => `
                <label for="${key}" class="radio-card">
                    <input type="radio" id="${key}" name="reservation_type" value="${key}" class="hidden">
                    <span class="checkmark"></span>
                    <div class="flex-grow flex flex-col justify-center">
                        <span class="text-xl font-bold text-gray-800">${value.label}</span>
                        <span class="text-gray-500 text-sm">${value.description}</span>
                    </div>

                </label>
            `).join('');

            contentContainer.innerHTML = `
                <h4 class="text-3xl font-bold text-gray-900 mb-8 text-center">
                    <i class="fa-solid fa-people-group text-green-600"></i> نوع الحجز
                </h4>
                <p class="text-gray-600 mb-8 text-center">اختر الأنسب لك للمتابعة وبناء فريقك.</p>
                <form id="reservation-type-form" onsubmit="event.preventDefault(); proceedToNextStep();">
                    <div class="space-y-4 mb-8">
                        ${choicesHtml}
                    </div>
                    
                    <!-- Player Count Input (only visible for 'team_looking_for_players') -->
                    <div id="player-count-input" class="mb-6 hidden">
                        <label for="player-count" class="block text-gray-700 font-semibold mb-2 text-right">عدد اللاعبين الحاليين في فريقك</label>
                        <input type="number" id="player-count" name="player_count" class="p-3 border border-gray-300 rounded-lg w-full text-right" placeholder="أدخل عدد اللاعبين">
                    </div>

                    <button type="submit" id="proceed-btn" class="bg-green-600 text-white font-bold py-4 px-8 rounded-xl w-full hover:bg-green-700 transition-all duration-300 shadow-lg text-lg btn-hover-effect">
                        <i class="fa-solid fa-arrow-left ml-2"></i> التالي
                    </button>
                </form>
            `;
            
            const radioButtons = document.querySelectorAll('input[name="reservation_type"]');
            const playerCountInputContainer = document.getElementById('player-count-input');
            const playerCountField = document.getElementById('player-count');
            
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelectorAll('.radio-card').forEach(card => card.classList.remove('selected'));
                    this.closest('.radio-card').classList.add('selected');

                    selectedReservationType = this.value;
                    const config = bookingTypes[selectedReservationType];
                    
                    // Show player count only for 'team_looking_for_players'
                    if (selectedReservationType === 'team_looking_for_players') {
                        playerCountInputContainer.classList.remove('hidden');
                        playerCountField.required = true;
                        playerCountField.min = config.min;
                        playerCountField.max = config.max;
                        playerCountField.value = ''; // Clear previous value
                        playerCountField.placeholder = `أدخل عدد اللاعبين الحاليين (${config.min}-${config.max})`;
                    } else {
                        playerCountInputContainer.classList.add('hidden');
                        playerCountField.required = false;
                        playerCountField.value = '';
                    }
                });
            });
        }

        function proceedToNextStep() {
            const form = document.getElementById('reservation-type-form');
            const formData = new FormData(form);
            selectedReservationType = formData.get('reservation_type');
            
            if (!selectedReservationType) {
                showMessageBox('خطأ في التحقق', 'يرجى اختيار نوع الحجز للمتابعة.', 'error');
                return;
            }
            
            const config = bookingTypes[selectedReservationType];
            
            if (selectedReservationType === 'team_looking_for_players') {
                selectedPlayerCount = parseInt(formData.get('player_count'));
                if (isNaN(selectedPlayerCount) || selectedPlayerCount < config.min || selectedPlayerCount > config.max) {
                    showMessageBox('خطأ في عدد اللاعبين', `عدد اللاعبين الحاليين يجب أن يكون بين ${config.min} و ${config.max} لاعب لفريقك.`, 'error');
                    return;
                }
            } else if (selectedReservationType === 'two_teams_ready') {
                selectedPlayerCount = config.min_per_team; // Use the min required per team (6) as the initial count for the initiator
            } else if (selectedReservationType === 'team_vs_team') {
                selectedPlayerCount = config.min_per_team; // Use the min required per team (6) as the initial count for the initiator
            } else if (selectedReservationType === 'players_looking_for_team') {
                selectedPlayerCount = 1; // Always 1 for single player
            } else {
                 selectedPlayerCount = 1; // Default fallback
            }
            
            // Set the reservation flow type
            reservationFlow = config.flow;
            
            // For single player request, go straight to handling (no availability step needed for now, but following the existing flow structure for date/time selection)
            if (reservationFlow === 'matchmaking_request') {
                // If it's a direct request (single player), we need to select date/time first.
                openModal('availability');
            } else {
                // For team building flows, move to availability step
                openModal('availability');
            }
        }

        // Step 2: Show availability (Mostly Unchanged)
        async function renderAvailabilityModal() {
            const contentContainer = document.getElementById('modal-content-container');
            const config = bookingTypes[selectedReservationType];
            
            let priceLabel = '';
            if (selectedReservationType === 'two_teams_ready') {
                priceLabel = 'السعر: سيظهر بعد اختيار الموعد';
            } else {
                priceLabel = 'السعر: -- شيكل';
            }
            
            contentContainer.innerHTML = `
                <h4 class="text-3xl font-bold text-gray-900 mb-8 text-center">
                    <i class="fa-solid fa-calendar-alt text-green-600"></i> اختر الموعد
                </h4>
                <div class="mb-6">
                    <label for="date-dropdown" class="block text-gray-700 font-semibold mb-2 text-right">اختر التاريخ</label>
                    <select id="date-dropdown" class="p-3 border border-gray-300 rounded-lg w-full text-right" required></select>
                </div>
                <div class="mb-6">
                    <label for="time-slots-container" class="block text-gray-700 font-semibold mb-2 text-right">اختر الوقت</label>
                    <div id="time-slots-container" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <!-- Time slots will be loaded dynamically -->
                    </div>
                </div>
                <div id="price-display" class="bg-gray-100 p-4 rounded-lg text-center font-bold text-gray-800 text-lg mb-6">
                    ${priceLabel}
                </div>
                <button type="button" id="confirm-availability-btn" class="bg-green-600 text-white font-bold py-4 px-8 rounded-xl w-full hover:bg-green-700 transition-all duration-300 shadow-lg text-lg btn-hover-effect" disabled>
                    <i class="fa-solid fa-arrow-left ml-2"></i> متابعة
                </button>
                <button onclick="renderReservationChoices()" class="mt-4 bg-gray-600 text-white font-bold py-4 px-8 rounded-xl w-full hover:bg-gray-700 transition-all duration-300 shadow-lg text-lg btn-hover-effect">
                    <i class="fa-solid fa-arrow-right ml-2"></i> العودة
                </button>
            `;

            const dateDropdown = document.getElementById('date-dropdown');
            const timeSlotsContainer = document.getElementById('time-slots-container');
            const priceDisplay = document.getElementById('price-display');
            const confirmBtn = document.getElementById('confirm-availability-btn');
            
            async function fetchAvailability(date) {
                timeSlotsContainer.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mb-3"></div>
                        <p class="text-gray-600">جاري تحميل المواعيد المتاحة...</p>
                    </div>
                `;
                selectedSlotId = null;
                confirmBtn.disabled = true;
                
                try {
                    const response = await fetch(`/api/availability/${selectedFieldData.id}?date=${date}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    
                    if (data.availability && data.availability.length > 0) {
                        timeSlotsContainer.innerHTML = '';
                        data.availability.forEach(slot => {
                            const slotBtn = document.createElement('button');
                            slotBtn.type = 'button';
                            slotBtn.className = 'bg-gray-200 text-gray-800 py-3 px-2 rounded-xl text-center font-semibold hover:bg-gray-300 transition-colors duration-200';
                            slotBtn.innerHTML = `${slot.start_time} - ${slot.end_time}`;
                            slotBtn.onclick = () => {
                                selectedSlotId = slot.id;
                                selectedSlotData = slot;
                                document.querySelectorAll('#time-slots-container button').forEach(btn => {
                                    btn.classList.remove('bg-green-600', 'text-white');
                                    btn.classList.add('bg-gray-200', 'text-gray-800');
                                });
                                slotBtn.classList.add('bg-green-600', 'text-white');
                                slotBtn.classList.remove('bg-gray-200', 'text-gray-800');

                                const startHour = parseInt(slot.start_time.split(':')[0]);
                                const endHour = parseInt(slot.end_time.split(':')[0]);
                                const duration = endHour - startHour;
                                const totalPrice = duration * selectedFieldData.price_per_hour;
                                
                                // Update price display based on reservation type
                                let priceText;
                                if (selectedReservationType === 'two_teams_ready') {
                                    priceText = `السعر: ${totalPrice} شيكل`;
                                } else {
                                    priceText = `الوقت المحدد: ${duration} ساعة.`;
                                }
                                
                                priceDisplay.innerText = priceText;
                                confirmBtn.disabled = false;
                                
                                // Update button text for single player direct submit
                                if (selectedReservationType === 'players_looking_for_team') {
                                    confirmBtn.innerHTML = `<i class="fa-solid fa-search ml-2"></i> إرسال طلب انضمام`;
                                } else {
                                    confirmBtn.innerHTML = `<i class="fa-solid fa-arrow-left ml-2"></i> متابعة`;
                                }
                            };
                            timeSlotsContainer.appendChild(slotBtn);
                        });
                    } else {
                        timeSlotsContainer.innerHTML = `
                            <div class="col-span-full text-center py-8">
                                <i class="fa-solid fa-calendar-xmark text-yellow-500 text-4xl mb-4"></i>
                                <p class="text-gray-600 text-lg mb-2">لا توجد مواعيد متاحة في هذا اليوم</p>
                                <p class="text-gray-500 text-sm">يرجى اختيار تاريخ آخر</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Failed to fetch availability:', error);
                    renderErrorState(timeSlotsContainer, 'فشل في تحميل المواعيد', 'حدث خطأ في الاتصال بالخادم');
                }
            }

            const dates = [];
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const dayName = new Intl.DateTimeFormat('ar-EG', { weekday: 'long' }).format(d);
                const dateString = d.toISOString().split('T')[0];
                dates.push({ date: dateString, display: `${d.toLocaleDateString('ar-EG')} - ${dayName}` });
            }

            dateDropdown.innerHTML = dates.map(d => `<option value="${d.date}">${d.display}</option>`).join('');
            selectedDate = dateDropdown.value;
            fetchAvailability(selectedDate);

            dateDropdown.addEventListener('change', (e) => {
                selectedDate = e.target.value;
                fetchAvailability(selectedDate);
            });

            confirmBtn.onclick = () => {
                handleBookingFlow();
            };
        }
        
        // Final Step: Handle reservation or matchmaking request
        async function handleBookingFlow() {
            if (!selectedSlotId) {
                showMessageBox('خطأ', 'يرجى اختيار موعد أولاً.');
                return;
            }

            const config = bookingTypes[selectedReservationType];
            
            if (config.flow === 'team_join_booking' || config.flow === 'team_join_matchmaking') {
                // Redirect to team-join page for team management
                const params = new URLSearchParams({
                    fieldId: selectedFieldData.id,
                    slotDate: selectedDate,
                    startTime: selectedSlotData.start_time,
                    endTime: selectedSlotData.end_time,
                    bookingType: selectedReservationType,
                    // Pass the initial player count provided by the user (only relevant for team_looking_for_players)
                    initialPlayerCount: selectedPlayerCount,
                    // Pass min/max limits to team-join for client-side enforcement
                    minTeamSize: selectedReservationType === 'two_teams_ready' ? 6 : config.min,
                    maxTeamSize: selectedReservationType === 'team_looking_for_players' ? 5 : config.max
                });
                window.location.href = `team-join.html?${params.toString()}`;
            } else if (config.flow === 'matchmaking_request') {
                // Direct matchmaking request for single player
                submitMatchmakingRequest();
            }
        }
        
        // This function is now specifically for Option 4: Player looking for a team
        async function submitMatchmakingRequest() {
            const confirmBtn = document.getElementById('confirm-availability-btn');
            const originalHtml = confirmBtn.innerHTML;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin ml-2"></i> جاري إرسال الطلب...`;

            try {
                const response = await fetch('/api/matchmake', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: loggedInUserId,
                        fieldId: selectedFieldData.id,
                        slotId: selectedSlotId,
                        requestType: selectedReservationType, // 'players_looking_for_team'
                        playersNeeded: 1 // Always 1 player initiating this request
                    })
                });

                if (response.ok) {
                    closeModal();
                    showMessageBox(
                        'تم إرسال طلبك',
                        'تم إرسال طلب انضمام كلاعب منفرد بنجاح. سيتم إعلامك عند العثور على فريق.',
                        'success'
                    );
                } else {
                    const errorData = await response.json();
                    showMessageBox('خطأ', errorData.error || 'فشل في إرسال طلبك. يرجى المحاولة لاحقاً.');
                }
            } catch (error) {
                console.error('Matchmaking request failed:', error);
                showMessageBox('خطأ في الشبكة', 'فشل الاتصال بالخادم. يرجى المحاولة لاحقاً.');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalHtml;
            }
        }

        // --- Render Fields (Updated) ---
        async function renderFields() {
            const container = document.getElementById('fields-container');
            container.innerHTML = ''; // Clear existing fields
            try {
                const response = await fetch('/api/fields');
                const data = await response.json();
                const fields = data.fields;

                if (fields && fields.length > 0) {
                    fields.forEach(field => {
                        const fieldCard = document.createElement('div');
                        fieldCard.className = 'bg-white rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 overflow-hidden transform hover:-translate-y-2 border border-gray-100';
                        const imageUrl = field.image ? `data:image/jpeg;base64,${field.image}` : `https://placehold.co/600x400/22c55e/ffffff?text=${field.name.replace(/\s/g, '+')}`;
                        
                        // New details display section
                        const detailsHtml = `
                            <div class="space-y-3 mt-4 text-right text-gray-700">
                                <!-- Address / Location -->
                                <div class="flex items-start">
                                    <i class="fa-solid fa-location-dot text-red-500 mt-1 ml-3 flex-shrink-0"></i>
                                    <span class="text-sm font-medium">${field.location || 'العنوان غير متوفر'}</span>
                                </div>
                                
                                <!-- Price Per Hour -->
                                <div class="flex items-center">
                                    <i class="fa-solid fa-money-bill-wave text-green-600 ml-3 flex-shrink-0"></i>
                                    <span class="text-md font-bold text-green-700">${field.price_per_hour} شيكل / ساعة</span>
                                </div>

                                <!-- Description (Shortened for card view) -->
                                <div class="flex items-start pt-2 border-t border-gray-100">
                                    <i class="fa-solid fa-circle-info text-blue-500 mt-1 ml-3 flex-shrink-0"></i>
                                    <p class="text-xs text-gray-600 leading-relaxed line-clamp-3">${field.description || 'لا يوجد وصف متاح لهذا الملعب.'}</p>
                                </div>
                            </div>
                        `;

                        fieldCard.innerHTML = `
                            <img
                                src="${imageUrl}"
                                alt="${field.name}"
                                class="w-full h-56 object-cover"
                                onerror="this.onerror=null;this.src='https://placehold.co/600x400/22c55e/ffffff?text=${field.name.replace(/\s/g, '+')}'"
                            />
                            <div class="p-6">
                                <h4 class="text-2xl font-bold mb-2 text-gray-900 flex items-center justify-center gap-2 text-center">
                                    <i class="fa-solid fa-futbol text-green-600"></i>
                                    ${field.name}
                                </h4>
                                
                                ${detailsHtml}
                                
                                <button
                                    onclick="openModal('field-details', ${field.id})"
                                    class="bg-gradient-to-r from-blue-600 to-blue-500 text-white px-8 py-3 rounded-xl hover:from-blue-700 hover:to-blue-600 transition-all duration-300 shadow-lg w-full text-lg transform hover:-translate-y-1 flex items-center justify-center gap-2 btn-hover-effect mt-6"
                                >
                                    <i class="fa-solid fa-calendar-plus"></i> احجز الآن
                                </button>
                            </div>
                        `;
                        container.appendChild(fieldCard);
                    });
                } else {
                    container.innerHTML = `<p class="text-center text-gray-500 text-xl w-full">لا توجد ملاعب متاحة حالياً.</p>`;
                }
            } catch (error) {
                console.error('Failed to fetch fields:', error);
                container.innerHTML = `<p class="text-center text-red-500 text-xl w-full">حدث خطأ في تحميل الملاعب. يرجى التأكد من تشغيل الخادم.</p>`;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderFields();
        });
    </script>
</body>
</html>
