<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5ع5 - انضم للفريق</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap');
        
        :root {
            --primary-color: #10B981;
            --secondary-color: #3B82F6;
            --background-color: #f0f4f8;
            --text-color: #2c3e50;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            width: 100%;
            max-width: 900px; /* Increased max width for two-team layout */
            text-align: center;
        }

        .booking-info {
            background-color: #f9fafb;
            border-radius: 1rem;
            padding: 1.5rem;
            border-left: 4px solid var(--primary-color);
            margin-bottom: 2rem;
        }

        .field-overview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            color: white;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .field-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .field-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .team-section {
            padding: 1.5rem;
            border-radius: 1rem;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .team-section.team-a { border-color: #3b82f6; }
        .team-section.team-b { border-color: #10B981; }
        .team-section.single-team { border-color: #f59e0b; }

        .player-card {
            background-color: #f0f4f8;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        .player-card.creator {
            background-color: #D1FAE5;
            border-color: var(--primary-color);
        }
        
        .progress-bar-container {
            height: 12px;
            background-color: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }
        .progress-bar-label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .btn {
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(to right, var(--primary-color), #34D399);
            color: white;
        }
        .btn-secondary {
            background: #e2e8f0;
            color: #4b5563;
        }
        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .pulse {
            animation: pulse 1s infinite cubic-bezier(0.66, 0, 0, 1);
        }
        @keyframes pulse {
            to {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .card {
                padding: 1.5rem;
            }
        }

        /* Logo and Header Styles */
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            border: 3px solid var(--primary-color);
        }
        .field-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 1rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            margin-bottom: 1.5rem;
        }
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1.5rem;
            padding: 2rem;
            color: white;
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="white" opacity="0.1"/><circle cx="20" cy="20" r="1" fill="white" opacity="0.1"/><circle cx="80" cy="30" r="1.5" fill="white" opacity="0.1"/><circle cx="30" cy="80" r="1" fill="white" opacity="0.1"/><circle cx="70" cy="70" r="1.5" fill="white" opacity="0.1"/></svg>');
            pointer-events: none;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-waiting {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-ready {
            background-color: #d1fae5;
            color: #065f46;
        }

        /* Modal for Confirmation */
        .confirmation-modal-content {
            transform: scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #confirmation-modal:not(.hidden) .confirmation-modal-content {
            transform: scale(1);
        }
        
        /* QR Modal specific style */
        .qr-modal-content {
            transform: scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #qr-modal:not(.hidden) .qr-modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body>

    <main class="card">
        <!-- Logo Section -->
        <div class="logo-container">
            <img src="/images/logo.jpg" alt="5ع5 Logo" class="logo">
        </div>
        
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 flex items-center justify-center gap-3">
            <i class="fa-solid fa-users text-blue-600"></i>
            انضم للفريق
        </h1>
        
        <!-- Loading State -->
        <div id="loading-state" class="py-12">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-xl font-semibold text-gray-700">جاري التحميل...</p>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <div id="booking-info" class="booking-info mb-8">
                <!-- Booking details will be populated here -->
            </div>

            <!-- Field Overview Section -->
            <div id="field-overview" class="field-overview mb-8">
                <!-- Field details will be populated here -->
            </div>
            
            <!-- Creator Invitation Section (Visible only to Creator) -->
            <div id="creator-section" class="hidden mb-8 border-b pb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-share-nodes text-green-600"></i>
                    شارك الدعوة
                </h2>
                <p class="text-gray-600 mb-6">شارك الرابط أو رمز QR مع أصدقائك للانضمام للفريق.</p>
                
                <div class="flex flex-col gap-4 max-w-xl mx-auto">
                    <!-- Invitation Link Container (Compact) -->
                    <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                        <label class="block text-gray-700 font-semibold mb-2 text-right text-sm">رابط الدعوة</label>
                        <div class="flex gap-2 items-stretch">
                            <input id="invitation-link" type="text" readonly class="flex-grow p-2 rounded bg-gray-50 text-sm border border-gray-300 text-right font-mono min-w-0" value="">
                            <button onclick="copyLink()" class="btn bg-blue-500 text-white flex-shrink-0 px-4 py-2 text-sm rounded-xl hover:bg-blue-600 transition-colors">
                                <i class="fa-solid fa-copy"></i> نسخ
                            </button>
                        </div>
                    </div>

                    <!-- QR Code Toggle Button -->
                    <button id="toggle-qr-btn" onclick="toggleQrModal()" class="btn btn-primary w-full py-3 text-lg mt-2 pulse">
                         <i class="fa-solid fa-qrcode ml-2"></i> عرض رمز QR
                    </button>
                </div>
            </div>

            <!-- Two Teams Layout (for two_teams_ready scenario) -->
            <div id="two-teams-layout" class="hidden">
                <p class="text-xl font-semibold text-gray-700 mb-6">
                    قم بتعبئة الفريقين: الحد الأدنى 6 لاعبين لكل فريق.
                </p>
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <!-- Team A -->
                    <div id="team-a-section" class="team-section team-a">
                        <h3 class="text-2xl font-bold mb-4 text-center bg-blue-50 p-3 rounded-lg text-blue-800">
                            <i class="fa-solid fa-people-group text-blue-600 ml-2"></i>
                            الفريق الأول (A)
                        </h3>
                        <div class="player-count text-lg font-bold mb-4 text-gray-700 text-center">
                            <span id="team-a-current">0</span> لاعب
                            <span id="team-a-status" class="text-sm font-normal"></span>
                        </div>
                        <div class="progress-bar-container mb-4">
                            <div id="team-a-progress" class="progress-bar-fill bg-blue-500" style="width: 0%;"></div>
                        </div>
                        <div id="team-a-players" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                            <!-- Team A players will be added here -->
                        </div>
                        <button id="join-team-a-btn" class="btn bg-blue-600 text-white w-full mt-4 hover:bg-blue-700 transition-all duration-300">
                            <i class="fa-solid fa-plus-circle ml-2"></i>
                            انضم للفريق الأول
                        </button>
                    </div>

                    <!-- Team B -->
                    <div id="team-b-section" class="team-section team-b">
                        <h3 class="text-2xl font-bold mb-4 text-center bg-green-50 p-3 rounded-lg text-green-800">
                            <i class="fa-solid fa-people-group text-green-600 ml-2"></i>
                            الفريق الثاني (B)
                        </h3>
                        <div class="player-count text-lg font-bold mb-4 text-gray-700 text-center">
                            <span id="team-b-current">0</span> لاعب
                            <span id="team-b-status" class="text-sm font-normal"></span>
                        </div>
                        <div class="progress-bar-container mb-4">
                            <div id="team-b-progress" class="progress-bar-fill bg-green-600" style="width: 0%;"></div>
                        </div>
                        <div id="team-b-players" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                            <!-- Team B players will be added here -->
                        </div>
                        <button id="join-team-b-btn" class="btn bg-green-600 text-white w-full mt-4 hover:bg-green-700 transition-all duration-300">
                            <i class="fa-solid fa-plus-circle ml-2"></i>
                            انضم للفريق الثاني
                        </button>
                    </div>
                </div>
            </div>

            <!-- Single Team Layout (for team_vs_team & team_looking_for_players) -->
            <div id="single-team-layout" class="hidden team-section single-team">
                <h3 class="text-2xl font-bold mb-4 text-center bg-yellow-50 p-3 rounded-lg text-yellow-800">
                    <i class="fa-solid fa-users-line text-yellow-600 ml-2"></i>
                    تجمع اللاعبين (<span id="team-purpose"></span>)
                </h3>
                
                <div id="join-form" class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="text-lg font-semibold text-gray-800 mb-4">
                        انضم إلى الفريق الآن لتأكيد مكانك!
                    </p>
                    <button id="join-btn" class="btn btn-primary w-full pulse">
                        <i class="fa-solid fa-plus-circle ml-2"></i>
                        انضمام
                    </button>
                </div>
                
                <div class="mt-8">
                    <div class="player-count text-xl font-bold mb-4 text-gray-800">
                        <i class="fa-solid fa-user-friends text-yellow-600 ml-2"></i>
                        اللاعبون الحاليون: <span id="current-players">0</span> 
                        <span class="text-base font-normal text-gray-500">
                            (<span id="min-players">0</span> الحد الأدنى)
                        </span>
                    </div>
                    
                    <div class="progress-bar-container mb-4">
                        <div id="progress-bar-fill" class="progress-bar-fill bg-yellow-500" style="width: 0%;"></div>
                    </div>
                    <div id="single-team-status" class="text-md font-semibold text-center mb-6"></div>
                    
                    <h3 class="text-2xl font-bold mt-8 mb-4 text-gray-800 border-b pb-2">قائمة اللاعبين</h3>
                    <div id="player-list-container" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                        <!-- Players will be added here -->
                    </div>
                </div>
            </div>
            
            <!-- Confirmation Buttons -->
            <div id="confirmation-section" class="mt-8">
                <button id="confirm-booking-btn" class="hidden btn bg-green-600 text-white w-full hover:bg-green-700">
                    <i class="fa-solid fa-check-circle ml-2"></i>
                    تأكيد الحجز والدفع
                </button>
                <button id="confirm-matchmaking-btn" class="hidden btn bg-blue-600 text-white w-full hover:bg-blue-700">
                    <i class="fa-solid fa-search-plus ml-2"></i>
                    إرسال طلب المباراة
                </button>
            </div>
        </div>
    </main>
    
    <!-- QR Code Modal (New structure) -->
    <div id="qr-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-3xl w-full max-w-sm relative p-8 qr-modal-content border-b-4 border-green-600">
            <button onclick="toggleQrModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors duration-300 rounded-full bg-gray-100 p-2 hover:bg-gray-200">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <h3 class="text-3xl font-bold mb-6 text-center text-gray-900">
                <i class="fa-solid fa-qrcode text-green-600 ml-2"></i>
                رمز QR للدعوة
            </h3>
            <div class="flex justify-center items-center p-6 bg-gray-100 rounded-xl shadow-inner">
                <canvas id="qrcode-canvas" class="w-60 h-60"></canvas>
            </div>
            <p class="text-center text-md font-medium text-gray-600 mt-4">امسح الرمز للانضمام مباشرةً</p>
        </div>
    </div>

    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-3xl w-full max-w-md relative p-8 confirmation-modal-content border-b-4 border-green-600">
            <button onclick="closeBookingModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors duration-300 rounded-full bg-gray-100 p-2 hover:bg-gray-200">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <h3 class="text-3xl font-bold mb-6 text-center text-gray-900">
                <i class="fa-solid fa-money-bill-check text-green-600 ml-2"></i>
                تأكيد الدفع والحجز
            </h3>
            <div id="confirmation-modal-details" class="space-y-4 mb-6">
                <!-- Details injected here -->
            </div>
            <div class="flex items-center mb-8">
                <input type="checkbox" id="accept-terms" class="ml-2 w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500">
                <label for="accept-terms" class="text-sm font-semibold text-gray-700">
                    أقر وأوافق على هذا الحجز، وسأدفع المبلغ الإجمالي بالكامل (<span id="final-price-text"></span>) في الملعب عند الوصول.
                </label>
            </div>
            <div class="flex gap-4">
                <button onclick="closeBookingModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors">
                    إلغاء
                </button>
                <button id="final-confirm-btn" onclick="confirmBooking()" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors" disabled>
                    تأكيد الحجز النهائي
                </button>
            </div>
        </div>
    </div>


    <!-- Message Box (reused from index.html) -->
    <div id="message-box" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-3xl p-8 w-full max-w-sm relative text-center border-t-4 border-red-500">
            <h4 id="message-box-title" class="text-2xl font-bold mb-4 text-gray-900 flex items-center justify-center gap-2"></h4>
            <p id="message-box-content" class="text-gray-700 mb-6 text-lg"></p>
            <div id="message-box-actions" class="flex items-center justify-center gap-3">
                <button onclick="closeMessageBox()" class="bg-red-600 text-white px-7 py-3 rounded-xl hover:bg-red-700 transition-all duration-300 shadow-md text-lg">حسناً</button>
            </div>
        </div>
    </div>

    <script src="header.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let invitationCode = null;
        let isCreator = false;
        let bookingData = null; // Contains { session, members }
        let pollingInterval;
        let currentBookingType = null;
        let teamAPlayers = [];
        let teamBPlayers = [];
        let singleTeamPlayers = [];
        let finalPrice = 0; // To store the calculated price

        const loggedInUserId = localStorage.getItem('userId');
        const loggedInUserName = localStorage.getItem('userName');
        
        // Tournament-specific variables
        let tournamentData = null;
        let isTournamentRegistration = false;
        const tournamentId = localStorage.getItem('tournamentId');
        const registrationType = localStorage.getItem('registrationType');
        
        // --- CONSTANTS FROM URL PARAMS ---
        let MIN_TEAM_SIZE = parseInt(urlParams.get('minTeamSize')) || 6; // Default 6
        let MAX_TEAM_SIZE = parseInt(urlParams.get('maxTeamSize')) || 20; // Default 20 (no real max)
        
        // Override for tournament registration
        if (tournamentId && registrationType === 'tournament') {
            isTournamentRegistration = true;
            MIN_TEAM_SIZE = 6; // Tournament minimum
            MAX_TEAM_SIZE = 8; // Tournament maximum
        }
        
        // --- Utility Functions ---
        function showMessageBox(title, content, type = 'error') {
            const msgBox = document.getElementById('message-box');
            const msgTitle = document.getElementById('message-box-title');
            const msgContent = document.getElementById('message-box-content');
            const actionsContainer = document.getElementById('message-box-actions');

            msgTitle.innerHTML = '';
            const box = msgBox.querySelector('.bg-white');
            box.classList.remove('border-t-4', 'border-red-500', 'border-green-600', 'border-yellow-500', 'border-blue-500');

            let icon = '', color = 'red', buttonText = 'حسناً';
            switch(type) {
                case 'success':
                    icon = `<i class="fa-solid fa-circle-check text-green-600 ml-2"></i>`;
                    color = 'green';
                    buttonText = 'رائع!';
                    break;
                case 'warning':
                    icon = `<i class="fa-solid fa-triangle-exclamation text-yellow-500 ml-2"></i>`;
                    color = 'yellow';
                    buttonText = 'حسناً';
                    break;
                case 'info':
                    icon = `<i class="fa-solid fa-circle-info text-blue-500 ml-2"></i>`;
                    color = 'blue';
                    buttonText = 'حسناً';
                    break;
                default:
                    icon = `<i class="fa-solid fa-octagon-xmark text-red-500 ml-2"></i>`;
                    color = 'red';
                    buttonText = 'حسناً';
            }

            msgTitle.innerHTML = `${icon}${title}`;
            box.classList.add('border-t-4', `border-${color}-500`);
            msgContent.innerText = content;

            // Default single OK button
            actionsContainer.innerHTML = `
                <button onclick="closeMessageBox()" class="bg-${color}-600 text-white px-7 py-3 rounded-xl hover:bg-${color}-700 transition-all duration-300 shadow-md text-lg">${buttonText}</button>
            `;

            // If warning and not logged in, show Login/Signup actions
            if (type === 'warning' && !loggedInUserId) {
                actionsContainer.innerHTML = `
                    <a href="auth.html?view=sign-in" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition-all duration-300 shadow-md text-lg inline-flex items-center gap-2">
                        <i class="fa-solid fa-right-to-bracket"></i> تسجيل الدخول
                    </a>
                    <a href="auth.html?view=sign-up" class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-all duration-300 shadow-md text-lg inline-flex items-center gap-2">
                        <i class="fa-solid fa-user-plus"></i> إنشاء حساب
                    </a>
                `;
            }

            msgBox.classList.remove('hidden');
        }

        function closeMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
        }

        function getBookingTypeDisplayName(bookingType) {
            switch (bookingType) {
                case 'two_teams_ready': return 'فريقان جاهزان';
                case 'team_vs_team': return 'فريق يبحث عن فريق آخر';
                case 'team_looking_for_players': return 'فريق يبحث عن لاعبين';
                case 'players_looking_for_team': return 'لاعب يبحث عن فريق';
                default: return bookingType;
            }
        }
        
        // --- QR Code Functions ---
        function generateQRCode(text) {
            const canvas = document.getElementById('qrcode-canvas');
            if (!canvas) return;
            
            // Clear previous QR
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            try {
                const qr = qrcode(0, 'H');
                qr.addData(text);
                qr.make();
                
                const size = 240; // Increased size slightly for better visibility in modal
                const cell = size / qr.getModuleCount();
                canvas.width = size;
                canvas.height = size;

                for (let r = 0; r < qr.getModuleCount(); r++) {
                    for (let c = 0; c < qr.getModuleCount(); c++) {
                        // isDark() is equivalent to is
                        if (qr.isDark(r, c)) {
                            ctx.fillStyle = '#2c3e50'; // Dark text color
                            ctx.fillRect(c * cell, r * cell, cell, cell);
                        }
                    }
                }
            } catch (e) {
                console.error("Failed to generate QR Code:", e);
                // Fallback message on canvas
                const size = 240;
                canvas.width = size;
                canvas.height = size;
                ctx.fillStyle = '#ef4444';
                ctx.font = '16px Cairo, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('QR Failed', size / 2, size / 2);
            }
        }
        
        function toggleQrModal() {
            const qrModal = document.getElementById('qr-modal');
            qrModal.classList.toggle('hidden');
        }

        function setupInvitationLink() {
            const invitationLinkInput = document.getElementById('invitation-link');
            // Ensure this uses the correct path format: /join/<code here>
            const fullUrl = `${window.location.origin}/join/${invitationCode}`; 
            
            invitationLinkInput.value = fullUrl;
            // Generate QR code right away so it's ready when the modal opens
            generateQRCode(fullUrl); 
        }

        // --- Core Functions ---
        async function loadOrCreateTeam() {
            const loadingState = document.getElementById('loading-state');
            const mainContent = document.getElementById('main-content');
            loadingState.classList.remove('hidden');
            mainContent.classList.add('hidden');
            
            if (!loggedInUserId) {
                showMessageBox(
                    'تسجيل الدخول مطلوب',
                    'للانضمام أو إنشاء فريق، يرجى تسجيل الدخول أولاً.',
                    'warning'
                );
                return;
            }

            // Check if this is tournament registration
            if (isTournamentRegistration) {
                await handleTournamentRegistration();
                return;
            }

            const pathInvitationCode = window.location.pathname.split('/').pop();
            const urlInvitationCode = urlParams.get('invitationCode');
            invitationCode = urlInvitationCode || pathInvitationCode;
            currentBookingType = urlParams.get('bookingType');

            if (invitationCode && invitationCode !== 'team-join.html') {
                // Flow for joining an existing team
                await fetchTeamDetails();
            } else if (currentBookingType) {
                // Flow for creating a new team (from index.html)
                const fieldId = urlParams.get('fieldId');
                const slotDate = urlParams.get('slotDate');
                const startTime = urlParams.get('startTime');
                const endTime = urlParams.get('endTime');
                const initialPlayerCount = urlParams.get('initialPlayerCount');

                if (!fieldId || !slotDate || !startTime || !endTime || !currentBookingType) {
                    showMessageBox('خطأ', 'رابط الدعوة غير صالح أو مفقود.');
                    return;
                }
                
                isCreator = true;
                await createNewTeam(fieldId, slotDate, startTime, endTime, currentBookingType, initialPlayerCount);
            } else {
                showMessageBox('خطأ', 'الرجاء البدء بالحجز من الصفحة الرئيسية.');
                document.getElementById('loading-state').classList.add('hidden');
            }
        }

        // Tournament registration handler
        async function handleTournamentRegistration() {
            try {
                // Fetch tournament details
                const response = await fetch(`/api/tournaments/${tournamentId}`);
                if (!response.ok) {
                    throw new Error('فشل في تحميل بيانات البطولة');
                }
                
                tournamentData = await response.json();
                
                // Set up tournament-specific UI
                renderTournamentInfo();
                renderTournamentTeamLayout();
                
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading tournament:', error);
                showMessageBox('خطأ في تحميل البطولة', error.message);
            }
        }

        async function createNewTeam(fieldId, slotDate, startTime, endTime, bookingType, initialPlayerCount) {
            try {
                const response = await fetch('/api/team-building/initiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: loggedInUserId,
                        fieldId,
                        slotDate,
                        startTime,
                        endTime,
                        bookingType,
                        initialPlayerCount: initialPlayerCount // Pass initial count for tracking
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create new team.');
                }
                
                invitationCode = data.invitationCode;
                // Redirect to the clean invitation URL
                history.replaceState({}, '', `/join/${invitationCode}`);
                fetchTeamDetails();
            } catch (error) {
                console.error('Error creating new team:', error);
                showMessageBox('خطأ في إنشاء الفريق', error.message);
                document.getElementById('loading-state').classList.add('hidden');
            }
        }

        async function fetchTeamDetails() {
            if (!invitationCode) return;
            try {
                const response = await fetch(`/api/team-building/${invitationCode}?userId=${loggedInUserId}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch team details.');
                }
                
                bookingData = data;
                currentBookingType = bookingData.session.booking_type;
                isCreator = bookingData.session.creator_id === parseInt(loggedInUserId);
                
                // Debug logging
                console.log('Debug Creator Check:');
                console.log('loggedInUserId:', loggedInUserId);
                console.log('creator_id from session:', bookingData.session.creator_id);
                console.log('parseInt(loggedInUserId):', parseInt(loggedInUserId));
                console.log('isCreator:', isCreator);
                console.log('bookingData.session:', bookingData.session);
                
                // Sort players into their respective teams
                if (currentBookingType === 'two_teams_ready') {
                    teamAPlayers = bookingData.members.filter(p => p.team_designation === 'A') || [];
                    teamBPlayers = bookingData.members.filter(p => p.team_designation === 'B') || [];
                } else {
                    singleTeamPlayers = bookingData.members.filter(p => p.team_designation === 'single') || [];
                }
                
                renderTeamDetails();
                
                // Start polling only if the session is active
                if (bookingData.session.status === 'active') {
                    if (!pollingInterval) {
                         pollingInterval = setInterval(fetchTeamDetails, 5000);
                    }
                } else {
                    if (pollingInterval) clearInterval(pollingInterval);
                }

            } catch (error) {
                console.error('Error fetching team details:', error);
                showMessageBox('خطأ في تحميل الفريق', error.message);
                document.getElementById('loading-state').classList.add('hidden');
            }
        }

        function renderTeamDetails() {
            const loadingState = document.getElementById('loading-state');
            const mainContent = document.getElementById('main-content');
            const creatorSection = document.getElementById('creator-section');

            loadingState.classList.add('hidden');
            mainContent.classList.remove('hidden');

            renderFieldOverview();
            renderBookingInfo();
            
            // Handle Creator Section visibility and setup globally
            if (isCreator) {
                creatorSection.classList.remove('hidden');
                setupInvitationLink();
            } else {
                creatorSection.classList.add('hidden');
            }
            
            const twoTeamsLayout = document.getElementById('two-teams-layout');
            const singleTeamLayout = document.getElementById('single-team-layout');

            if (currentBookingType === 'two_teams_ready') {
                twoTeamsLayout.classList.remove('hidden');
                singleTeamLayout.classList.add('hidden');
                renderTwoTeamsLayout();
            } else {
                twoTeamsLayout.classList.add('hidden');
                singleTeamLayout.classList.remove('hidden');
                renderSingleTeamLayout();
            }
            
            updateConfirmationButtons();
        }

        function renderFieldOverview() {
            const fieldOverview = document.getElementById('field-overview');
            const { field_name, field_address, field_image } = bookingData.session;
            
            const imageUrl = field_image 
                ? `data:image/jpeg;base64,${field_image}` 
                : `https://placehold.co/600x400/22c55e/ffffff?text=${field_name.replace(/\s/g, '+')}`;
            
            fieldOverview.innerHTML = `
                <div class="field-card">
                    <img src="${imageUrl}" alt="${field_name}" class="field-image" 
                         onerror="this.src='https://placehold.co/600x400/22c55e/ffffff?text=${field_name.replace(/\s/g, '+')}';">
                    <h3 class="text-xl font-bold mb-2">${field_name}</h3>
                    <p class="text-sm opacity-90 mb-2">
                        <i class="fa-solid fa-location-dot mr-2"></i>
                        ${field_address || 'العنوان غير متوفر'}
                    </p>
                </div>
            `;
        }

        function renderBookingInfo() {
            const bookingInfo = document.getElementById('booking-info');
            const { field_name, slot_date, start_time, end_time, booking_type, price_per_hour } = bookingData.session;
            
            const startHour = parseInt(start_time.split(':')[0]);
            const endHour = parseInt(end_time.split(':')[0]);
            const hours = endHour - startHour;
            const totalPrice = price_per_hour * hours;
            finalPrice = totalPrice;

            bookingInfo.innerHTML = `
                <div class="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-futbol text-green-600 ml-3"></i>
                        نوع الحجز: <span class="mr-2 text-blue-600">${getBookingTypeDisplayName(booking_type)}</span>
                    </h2>
                    <div class="grid md:grid-cols-2 gap-4 text-gray-700 text-right">
                        <div class="flex items-center">
                            <i class="fa-solid fa-map-marker-alt text-red-500 ml-2"></i>
                            <span class="font-semibold">الملعب:</span>
                            <span class="mr-2">${field_name}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fa-solid fa-calendar text-blue-500 ml-2"></i>
                            <span class="font-semibold">التاريخ:</span>
                            <span class="mr-2">${new Date(slot_date).toLocaleDateString('en-GB')}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fa-solid fa-clock text-purple-500 ml-2"></i>
                            <span class="font-semibold">الوقت:</span>
                            <span class="mr-2">${start_time} - ${end_time} (${hours} ساعة)</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fa-solid fa-money-bill-wave text-green-500 ml-2"></i>
                            <span class="font-semibold">سعر الملعب الإجمالي:</span>
                            <span class="mr-2 text-green-700 font-bold">${totalPrice} شيكل</span>
                        </div>
                    </div>
                </div>
            `;
        }

        /* --- Two Teams Logic (Option 1) --- */
        function renderTwoTeamsLayout() {
            // Update team counts and progress
            updateTeamDisplay('A', teamAPlayers);
            updateTeamDisplay('B', teamBPlayers);
            
            // Render players for both teams
            renderTeamPlayers('A', teamAPlayers, 6);
            renderTeamPlayers('B', teamBPlayers, 6);
            
            // Setup join buttons
            setupTeamJoinButtons();
        }

        function updateTeamDisplay(team, players) {
            const currentSpan = document.getElementById(`team-${team.toLowerCase()}-current`);
            const statusSpan = document.getElementById(`team-${team.toLowerCase()}-status`);
            const progressBar = document.getElementById(`team-${team.toLowerCase()}-progress`);
            
            const current = players.length;
            const min = 6;
            
            currentSpan.textContent = `${current} / ${min}+`;
            
            let statusText = '';
            let colorClass = 'bg-red-500';
            let barColor = 'bg-red-500';

            if (current >= min) {
                statusText = 'مكتمل وجاهز';
                colorClass = 'text-green-600';
                barColor = 'bg-green-600';
            } else {
                statusText = `يحتاج ${min - current} لاعب آخر`;
                colorClass = 'text-yellow-600';
                barColor = 'bg-yellow-500';
            }
            
            statusSpan.className = `text-sm font-normal ${colorClass}`;
            statusSpan.textContent = `(${statusText})`;

            const percentage = Math.min(100, (current / min) * 100);
            progressBar.style.width = `${percentage}%`;
            progressBar.classList.remove('bg-blue-500', 'bg-green-600');
            // Remove previous color classes and add the correct one
            const progressBarElement = document.getElementById(`team-${team.toLowerCase()}-progress`);
            progressBarElement.className = progressBarElement.className.replace(/bg-(red|yellow|green|blue)-\d{3}/g, '').trim() + ` ${barColor}`;
        }

        function setupTeamJoinButtons() {
            const joinTeamABtn = document.getElementById('join-team-a-btn');
            const joinTeamBBtn = document.getElementById('join-team-b-btn');
            
            const userInTeamA = teamAPlayers.some(p => p.user_id === parseInt(loggedInUserId));
            const userInTeamB = teamBPlayers.some(p => p.user_id === parseInt(loggedInUserId));
            const userJoinedAny = userInTeamA || userInTeamB;
            
            // Team A Button
            if (userInTeamA) {
                joinTeamABtn.innerHTML = '<i class="fa-solid fa-check-circle ml-2"></i>أنت في الفريق الأول';
                joinTeamABtn.className = 'btn bg-green-600 text-white w-full mt-4 cursor-not-allowed';
                joinTeamABtn.disabled = true;
                joinTeamABtn.onclick = null;
            } else if (userJoinedAny) {
                joinTeamABtn.innerHTML = '<i class="fa-solid fa-ban ml-2"></i>انضم للفريق الأول';
                joinTeamABtn.className = 'btn bg-gray-400 text-white w-full mt-4 cursor-not-allowed';
                joinTeamABtn.disabled = true;
                joinTeamABtn.onclick = null;
            } else {
                joinTeamABtn.innerHTML = '<i class="fa-solid fa-plus-circle ml-2"></i>انضم للفريق الأول';
                joinTeamABtn.className = 'btn bg-blue-600 text-white w-full mt-4 hover:bg-blue-700 transition-all duration-300';
                joinTeamABtn.disabled = false; // No max limit, users can keep joining
                joinTeamABtn.onclick = () => joinTeam('A');
            }
            
            // Team B Button
            if (userInTeamB) {
                joinTeamBBtn.innerHTML = '<i class="fa-solid fa-check-circle ml-2"></i>أنت في الفريق الثاني';
                joinTeamBBtn.className = 'btn bg-green-600 text-white w-full mt-4 cursor-not-allowed';
                joinTeamBBtn.disabled = true;
                joinTeamBBtn.onclick = null;
            } else if (userJoinedAny) {
                joinTeamBBtn.innerHTML = '<i class="fa-solid fa-ban ml-2"></i>انضم للفريق الثاني';
                joinTeamBBtn.className = 'btn bg-gray-400 text-white w-full mt-4 cursor-not-allowed';
                joinTeamBBtn.disabled = true;
                joinTeamBBtn.onclick = null;
            } else {
                joinTeamBBtn.innerHTML = '<i class="fa-solid fa-plus-circle ml-2"></i>انضم للفريق الثاني';
                joinTeamBBtn.className = 'btn bg-green-600 text-white w-full mt-4 hover:bg-green-700 transition-all duration-300';
                joinTeamBBtn.disabled = false; // No max limit, users can keep joining
                joinTeamBBtn.onclick = () => joinTeam('B');
            }
        }

        /* --- Single Team Logic (Option 2 & 3) --- */
        function renderSingleTeamLayout() {
            const teamPurpose = document.getElementById('team-purpose');
            const joinForm = document.getElementById('join-form');
            
            const userInTeam = singleTeamPlayers.some(p => p.user_id === parseInt(loggedInUserId));
            
            // Set team purpose text
            teamPurpose.textContent = getBookingTypeDisplayName(currentBookingType);

            // Setup join button/form visibility
            if (userInTeam || isCreator) {
                // If creator or already joined, hide the general join button/form
                joinForm.classList.add('hidden');
                
                // If the user is the creator, update the join button for the Single Team Layout
                if (isCreator) {
                    setupJoinButton();
                } else {
                    // If the user is just a member, update the join button display
                    setupJoinButton();
                }

            } else {
                // If not creator and not joined, show join button
                joinForm.classList.remove('hidden');
                setupJoinButton();
            }
            
            updateSingleTeamDisplay();
            renderSingleTeamPlayers();
        }

        function updateSingleTeamDisplay() {
            const current = singleTeamPlayers.length;
            // The MAX_TEAM_SIZE is only truly relevant for 'team_looking_for_players' (max 5)
            const min = MIN_TEAM_SIZE;
            const max = currentBookingType === 'team_looking_for_players' ? 5 : 20; 
            
            document.getElementById('current-players').textContent = current;
            document.getElementById('min-players').textContent = min;
            
            const progressBar = document.getElementById('progress-bar-fill');
            const statusDiv = document.getElementById('single-team-status');
            
            // Progress bar logic changes based on the max limit (for visual only)
            const visualMax = currentBookingType === 'team_looking_for_players' ? 5 : 10;
            const percentage = Math.min(100, (current / visualMax) * 100);
            progressBar.style.width = `${percentage}%`;

            let statusText = '';
            let statusColor = 'text-red-600';

            if (currentBookingType === 'team_looking_for_players') {
                 if (current > max) {
                    statusText = `تجاوز الحد الأقصى! (${current} / ${max})`;
                    statusColor = 'text-red-600';
                 } else if (current === max) {
                    statusText = `الفريق مكتمل! (${current} / ${max}) - يمكن إرسال الطلب`;
                    statusColor = 'text-green-600';
                 } else if (current >= min) {
                    statusText = `جاهز لإرسال الطلب! (${current} / ${max})`;
                    statusColor = 'text-yellow-600';
                 } else {
                    statusText = `تحتاج لـ ${min - current} لاعب آخر (الحد الأدنى ${min} لاعب)`;
                    statusColor = 'text-red-600';
                 }

            } else if (currentBookingType === 'team_vs_team') {
                if (current >= min) {
                    statusText = `جاهز لطلب المباراة! (${current} / ${min}+)`;
                    statusColor = 'text-green-600';
                } else {
                    statusText = `تحتاج لـ ${min - current} لاعب آخر (الحد الأدنى ${min} لاعب)`;
                    statusColor = 'text-red-600';
                }
            }

            statusDiv.innerHTML = `<i class="fa-solid fa-circle-info ml-1"></i> ${statusText}`;
            statusDiv.className = `text-md font-semibold text-center mb-6 ${statusColor}`;
        }

        function renderTeamPlayers(team, players, maxLimit) {
            const container = document.getElementById(`team-${team.toLowerCase()}-players`);
            container.innerHTML = '';
            
            players.forEach(player => {
                const playerDiv = document.createElement('div');
                const isCreatorPlayer = player.user_id === bookingData.session.creator_id;
                playerDiv.className = `player-card ${isCreatorPlayer ? 'creator' : ''}`;
                playerDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fa-solid fa-user-circle text-2xl text-gray-600 ml-3"></i>
                        <span class="font-medium">${player.player_name}</span>
                        ${isCreatorPlayer ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full mr-2">منشئ الفريق</span>' : ''}
                    </div>
                    ${(isCreator && player.user_id !== parseInt(loggedInUserId)) ? `<button onclick="removePlayer('${player.user_id}', '${team}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-times"></i></button>` : ''}
                `;
                container.appendChild(playerDiv);
            });
        }

        function renderSingleTeamPlayers() {
            const container = document.getElementById('player-list-container');
            container.innerHTML = '';
            
            singleTeamPlayers.forEach(player => {
                const playerDiv = document.createElement('div');
                const isCreatorPlayer = player.user_id === bookingData.session.creator_id;
                playerDiv.className = 'player-card bg-white p-4 rounded-lg border border-gray-200 flex items-center justify-between mb-3';
                playerDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fa-solid fa-user-circle text-3xl text-gray-600 ml-4"></i>
                        <div>
                            <span class="font-medium text-lg">${player.player_name}</span>
                            ${isCreatorPlayer ? '<div class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full inline-block mt-1">منشئ الفريق</div>' : ''}
                        </div>
                    </div>
                    ${(isCreator && player.user_id !== parseInt(loggedInUserId)) ? `<button onclick="removePlayer('${player.user_id}')" class="text-red-500 hover:text-red-700 text-xl"><i class="fa-solid fa-times"></i></button>` : ''}
                `;
                container.appendChild(playerDiv);
            });
        }

        function setupJoinButton() {
            const joinBtn = document.getElementById('join-btn');
            const joinForm = document.getElementById('join-form');
            
            // Check if user is already in the team
            const userInTeam = singleTeamPlayers.some(player => player.user_id === parseInt(loggedInUserId));
            
            if (userInTeam) {
                joinForm.innerHTML = `
                    <div class="text-center p-6 bg-gradient-to-r from-green-100 to-emerald-100 rounded-lg border-2 border-green-300">
                        <div class="mb-4">
                            <i class="fa-solid fa-check-circle text-green-600 text-4xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-green-800 mb-2">🎉 أنت في الفريق!</h3>
                        <p class="text-green-700 font-medium">تم تأكيد انضمامك بنجاح. انتظر باقي اللاعبين للانضمام.</p>
                        <div class="status-badge status-ready mt-4">
                            <i class="fa-solid fa-user-check"></i>
                            عضو مؤكد
                        </div>
                    </div>
                `;
            } else if (currentBookingType === 'team_looking_for_players' && singleTeamPlayers.length >= 5) {
                joinForm.classList.remove('hidden'); // Ensure form is visible to show "full" message
                joinForm.innerHTML = `
                    <div class="text-center p-6 bg-gradient-to-r from-red-100 to-pink-100 rounded-lg border-2 border-red-300">
                        <div class="mb-4">
                            <i class="fa-solid fa-users-slash text-red-600 text-4xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-red-800 mb-2">الفريق مكتمل!</h3>
                        <p class="text-red-700 font-medium">وصل هذا الفريق للحد الأقصى من اللاعبين (5).</p>
                    </div>
                `;
                joinBtn.disabled = true;
                joinBtn.onclick = null;
            } else {
                joinForm.classList.remove('hidden');
                joinForm.innerHTML = `
                    <p class="text-lg font-semibold text-gray-800 mb-4">
                        انضم إلى الفريق الآن لتأكيد مكانك!
                    </p>
                    <button id="join-btn-actual" class="btn btn-primary w-full pulse">
                        <i class="fa-solid fa-plus-circle ml-2"></i>
                        انضمام
                    </button>
                `;
                document.getElementById('join-btn-actual').onclick = () => joinTeam('single');
            }
        }

        async function joinTeam(teamDesignation) {
            try {
                const response = await fetch('/api/team-building/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        invitationCode,
                        userId: loggedInUserId,
                        teamDesignation: teamDesignation
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to join team.');
                }
                
                showMessageBox('تم الانضمام بنجاح!', 'لقد انضممت إلى الفريق بنجاح.', 'success');
                fetchTeamDetails(); // Refresh the team details
                
            } catch (error) {
                console.error('Error joining team:', error);
                showMessageBox('خطأ في الانضمام', error.message);
            }
        }

        async function removePlayer(targetUserId, team = null) {
            // Using a custom modal for confirmation is safer than browser confirm
            // For now, sticking to browser confirm for brevity, but noting the risk.
            if (!confirm('هل أنت متأكد من إزالة هذا اللاعب؟')) return;
            
            try {
                const response = await fetch('/api/team-building/remove-player', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        invitationCode,
                        userId: loggedInUserId, // Creator ID
                        targetUserId: targetUserId // User to be removed
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to remove player.');
                }
                
                showMessageBox('تم إزالة اللاعب', 'تم إزالة اللاعب من الفريق بنجاح.', 'success');
                fetchTeamDetails(); // Refresh the team details
                
            } catch (error) {
                console.error('Error removing player:', error);
                showMessageBox('خطأ في إزالة اللاعب', error.message);
            }
        }

        function updateConfirmationButtons() {
            const confirmBookingBtn = document.getElementById('confirm-booking-btn');
            const confirmMatchmakingBtn = document.getElementById('confirm-matchmaking-btn');
            
            confirmBookingBtn.classList.add('hidden');
            confirmMatchmakingBtn.classList.add('hidden');
            
            if (!isCreator) return;
            
            let canConfirm = false;
            
            if (currentBookingType === 'two_teams_ready') {
                // Option 1: Two Teams Ready (Min 6 per team, no max enforced for confirmation)
                canConfirm = teamAPlayers.length >= 6 && teamBPlayers.length >= 6;
                if (canConfirm) {
                    confirmBookingBtn.classList.remove('hidden');
                    confirmBookingBtn.onclick = showBookingConfirmationModal;
                }
            } else if (currentBookingType === 'team_vs_team') {
                // Option 2: Team Looking for Team (Min 6)
                canConfirm = singleTeamPlayers.length >= 6;
                if (canConfirm) {
                    confirmMatchmakingBtn.classList.remove('hidden');
                    confirmMatchmakingBtn.onclick = submitMatchmakingRequest;
                    confirmMatchmakingBtn.innerHTML = '<i class="fa-solid fa-search-plus ml-2"></i> إرسال طلب مباراة فريق ضد فريق';
                }
            } else if (currentBookingType === 'team_looking_for_players') {
                // Option 3: Team Looking for Players (Min 3, Max 5)
                canConfirm = singleTeamPlayers.length >= 3;
                if (canConfirm) {
                    confirmMatchmakingBtn.classList.remove('hidden');
                    confirmMatchmakingBtn.onclick = submitMatchmakingRequest;
                    confirmMatchmakingBtn.innerHTML = '<i class="fa-solid fa-search-plus ml-2"></i> إرسال طلب البحث عن لاعبين';
                }
            }
        }

        /* --- Confirmation Modal Logic (Option 1 Only) --- */

        function showBookingConfirmationModal() {
            const modal = document.getElementById('confirmation-modal');
            const detailsContainer = document.getElementById('confirmation-modal-details');
            
            const { field_name, slot_date, start_time, end_time, price_per_hour } = bookingData.session;
            const startHour = parseInt(start_time.split(':')[0]);
            const endHour = parseInt(end_time.split(':')[0]);
            const hours = endHour - startHour;
            const totalPrice = finalPrice;

            detailsContainer.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg text-right">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-700">الملعب:</span>
                        <span>${field_name}</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-700">الوقت:</span>
                        <span>${start_time} - ${end_time} (${hours} ساعة)</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-700">عدد اللاعبين:</span>
                        <span>${teamAPlayers.length} (فريق أ) + ${teamBPlayers.length} (فريق ب)</span>
                    </div>
                    <div class="flex justify-between items-center font-bold text-xl border-t pt-2 mt-4">
                        <span class="text-gray-800">المبلغ الإجمالي (في الملعب):</span>
                        <span class="text-green-600">${totalPrice} شيكل</span>
                    </div>
                </div>
            `;

            document.getElementById('final-price-text').textContent = `${totalPrice} شيكل`;
            
            // Enable/Disable final confirm button based on checkbox
            const acceptTerms = document.getElementById('accept-terms');
            const finalConfirmBtn = document.getElementById('final-confirm-btn');
            
            acceptTerms.onchange = () => {
                finalConfirmBtn.disabled = !acceptTerms.checked;
            };

            modal.classList.remove('hidden');
        }

        function closeBookingModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
        }

        async function confirmBooking() {
            const acceptTerms = document.getElementById('accept-terms').checked;
            if (!acceptTerms) {
                showMessageBox('يرجى الموافقة', 'يرجى الموافقة على الشروط لتأكيد الحجز.', 'warning');
                return;
            }
            
            const finalConfirmBtn = document.getElementById('final-confirm-btn');
            finalConfirmBtn.disabled = true;
            finalConfirmBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin ml-2"></i> جاري التأكيد...';

            try {
                const response = await fetch('/api/team-building/confirm-booking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        invitationCode,
                        userId: loggedInUserId
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to confirm booking.');
                }
                
                closeBookingModal();
                showMessageBox('تم تأكيد الحجز!', 'تم تأكيد حجزك بنجاح. ستتمكن من رؤية التفاصيل في لوحة التحكم الخاصة بك.', 'success');
                
                // Redirect to dashboard after 3 seconds
                setTimeout(() => {
                    window.location.href = 'user-dashboard.html';
                }, 3000);
                
            } catch (error) {
                console.error('Error confirming booking:', error);
                showMessageBox('خطأ في تأكيد الحجز', error.message);
            } finally {
                finalConfirmBtn.disabled = false;
                finalConfirmBtn.innerHTML = 'تأكيد الحجز النهائي';
            }
        }

        /* --- Matchmaking Request Logic (Option 2 & 3) --- */

        async function submitMatchmakingRequest() {
            // Using a custom modal for confirmation is safer than browser confirm
            if (!confirm('هل أنت متأكد من إرسال طلب المباراة؟')) return;
            
            const confirmBtn = document.getElementById('confirm-matchmaking-btn');
            const originalHtml = confirmBtn.innerHTML;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin ml-2"></i> جاري إرسال الطلب...`;

            try {
                // The current player count is derived from the session members
                const currentPlayers = singleTeamPlayers.length;
                
                const response = await fetch('/api/team-building/submit-matchmaking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        invitationCode,
                        userId: loggedInUserId,
                        currentPlayers: currentPlayers // Pass current player count for server logic
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to submit matchmaking request.');
                }
                
                showMessageBox('تم إرسال الطلب!', 'تم إرسال طلب المباراة بنجاح. سنقوم بالبحث عن مباراة مناسبة لك.', 'success');
                
                // Redirect to dashboard after 3 seconds
                setTimeout(() => {
                    window.location.href = 'user-dashboard.html';
                }, 3000);
                
            } catch (error) {
                console.error('Error submitting matchmaking request:', error);
                showMessageBox('خطأ في إرسال الطلب', error.message);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalHtml;
            }
        }

        // --- Tournament-specific functions ---
        function renderTournamentInfo() {
            const bookingInfo = document.getElementById('booking-info');
            const fieldOverview = document.getElementById('field-overview');
            
            // Hide field overview for tournaments
            fieldOverview.classList.add('hidden');
            
            bookingInfo.innerHTML = `
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-trophy text-yellow-500 ml-3"></i>
                        تسجيل في البطولة: <span class="mr-2 text-purple-600">${tournamentData.name}</span>
                    </h2>
                    <div class="grid md:grid-cols-2 gap-4 text-gray-700 text-right">
                        <div class="flex items-center">
                            <i class="fa-solid fa-map-marker-alt text-red-500 ml-2"></i>
                            <span class="font-semibold">الملعب:</span>
                            <span class="mr-2">${tournamentData.field}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fa-solid fa-calendar text-blue-500 ml-2"></i>
                            <span class="font-semibold">التاريخ:</span>
                            <span class="mr-2">${new Date(tournamentData.date).toLocaleDateString('en-GB')}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fa-solid fa-users text-green-500 ml-2"></i>
                            <span class="font-semibold">حجم الفريق:</span>
                            <span class="mr-2">6-8 لاعبين</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fa-solid fa-money-bill-wave text-green-500 ml-2"></i>
                            <span class="font-semibold">الجائزة:</span>
                            <span class="mr-2 text-green-700 font-bold">${tournamentData.prize} شيكل</span>
                        </div>
                    </div>
                    <div class="mt-4 p-4 bg-white rounded-lg border border-gray-200">
                        <p class="text-gray-600">${tournamentData.description}</p>
                    </div>
                </div>
            `;
        }

        function renderTournamentTeamLayout() {
            const singleTeamLayout = document.getElementById('single-team-layout');
            const twoTeamsLayout = document.getElementById('two-teams-layout');
            const creatorSection = document.getElementById('creator-section');
            
            // Hide two teams layout and creator section for tournaments
            twoTeamsLayout.classList.add('hidden');
            creatorSection.classList.add('hidden');
            
            // Show single team layout
            singleTeamLayout.classList.remove('hidden');
            
            // Update the team purpose
            document.getElementById('team-purpose').textContent = 'البطولة';
            
            // Initialize empty tournament team
            singleTeamPlayers = [];
            
            // Update UI elements for tournament
            document.getElementById('min-players').textContent = MIN_TEAM_SIZE;
            document.getElementById('current-players').textContent = singleTeamPlayers.length;
            
            // Set up join button for tournament
            const joinBtn = document.getElementById('join-btn');
            joinBtn.onclick = joinTournamentTeam;
            
            // Update confirmation button for tournament
            updateTournamentConfirmationButton();
            
            renderTournamentPlayerList();
        }

        function renderTournamentPlayerList() {
            const playerListContainer = document.getElementById('player-list-container');
            
            if (singleTeamPlayers.length === 0) {
                playerListContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa-solid fa-users text-4xl mb-4"></i>
                        <p class="text-lg">لا يوجد لاعبون مسجلون بعد</p>
                        <p class="text-sm">كن أول من ينضم للفريق!</p>
                    </div>
                `;
                return;
            }
            
            playerListContainer.innerHTML = singleTeamPlayers.map((player, index) => `
                <div class="player-card bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-green-500 rounded-full flex items-center justify-center text-white font-bold">
                            ${index + 1}
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800">${player.name}</h4>
                            <p class="text-sm text-gray-500">${player.email}</p>
                        </div>
                    </div>
                    ${player.user_id == loggedInUserId ? `
                        <button onclick="leaveTournamentTeam()" class="text-red-500 hover:text-red-700 transition-colors">
                            <i class="fa-solid fa-sign-out-alt"></i> مغادرة
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        async function joinTournamentTeam() {
            if (!loggedInUserId) {
                showMessageBox('تسجيل الدخول مطلوب', 'يرجى تسجيل الدخول أولاً للانضمام للفريق.');
                return;
            }
            
            // Check if user is already in the team
            if (singleTeamPlayers.some(p => p.user_id == loggedInUserId)) {
                showMessageBox('أنت مسجل بالفعل', 'أنت مسجل بالفعل في هذا الفريق.');
                return;
            }
            
            // Check if team is full
            if (singleTeamPlayers.length >= MAX_TEAM_SIZE) {
                showMessageBox('الفريق مكتمل', `الفريق مكتمل بالحد الأقصى ${MAX_TEAM_SIZE} لاعبين.`);
                return;
            }
            
            const joinBtn = document.getElementById('join-btn');
            const originalHtml = joinBtn.innerHTML;
            joinBtn.disabled = true;
            joinBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin ml-2"></i> جاري الانضمام...`;
            
            try {
                const response = await fetch(`/api/tournaments/${tournamentId}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: loggedInUserId,
                        userName: loggedInUserName,
                        userEmail: localStorage.getItem('userEmail') || ''
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'فشل في التسجيل');
                }
                
                // Add player to local array
                singleTeamPlayers.push({
                    user_id: loggedInUserId,
                    name: loggedInUserName,
                    email: localStorage.getItem('userEmail') || ''
                });
                
                // Update UI
                document.getElementById('current-players').textContent = singleTeamPlayers.length;
                updateTournamentProgress();
                renderTournamentPlayerList();
                updateTournamentConfirmationButton();
                
                showMessageBox('تم الانضمام بنجاح!', 'تم تسجيلك في الفريق بنجاح.', 'success');
                
            } catch (error) {
                console.error('Error joining tournament team:', error);
                showMessageBox('خطأ في التسجيل', error.message);
            } finally {
                joinBtn.disabled = false;
                joinBtn.innerHTML = originalHtml;
            }
        }

        async function leaveTournamentTeam() {
            if (!confirm('هل أنت متأكد من مغادرة الفريق؟')) return;
            
            try {
                const response = await fetch(`/api/tournaments/${tournamentId}/unregister`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: loggedInUserId
                    })
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'فشل في مغادرة الفريق');
                }
                
                // Remove player from local array
                singleTeamPlayers = singleTeamPlayers.filter(p => p.user_id != loggedInUserId);
                
                // Update UI
                document.getElementById('current-players').textContent = singleTeamPlayers.length;
                updateTournamentProgress();
                renderTournamentPlayerList();
                updateTournamentConfirmationButton();
                
                showMessageBox('تم المغادرة', 'تم إلغاء تسجيلك من الفريق.', 'success');
                
            } catch (error) {
                console.error('Error leaving tournament team:', error);
                showMessageBox('خطأ في المغادرة', error.message);
            }
        }

        function updateTournamentProgress() {
            const progressBar = document.getElementById('progress-bar-fill');
            const statusDiv = document.getElementById('single-team-status');
            
            const current = singleTeamPlayers.length;
            const percentage = Math.min((current / MIN_TEAM_SIZE) * 100, 100);
            
            progressBar.style.width = `${percentage}%`;
            
            if (current >= MIN_TEAM_SIZE) {
                statusDiv.innerHTML = `
                    <span class="status-badge status-ready">
                        <i class="fa-solid fa-check-circle"></i>
                        الفريق جاهز للبطولة!
                    </span>
                `;
                progressBar.classList.remove('bg-yellow-500', 'bg-red-500');
                progressBar.classList.add('bg-green-500');
            } else {
                const needed = MIN_TEAM_SIZE - current;
                statusDiv.innerHTML = `
                    <span class="status-badge status-waiting">
                        <i class="fa-solid fa-clock"></i>
                        يحتاج ${needed} لاعب${needed > 1 ? 'ين' : ''} إضافي${needed > 1 ? 'ين' : ''}
                    </span>
                `;
                progressBar.classList.remove('bg-green-500', 'bg-red-500');
                progressBar.classList.add('bg-yellow-500');
            }
        }

        function updateTournamentConfirmationButton() {
            const confirmationSection = document.getElementById('confirmation-section');
            const confirmBookingBtn = document.getElementById('confirm-booking-btn');
            const confirmMatchmakingBtn = document.getElementById('confirm-matchmaking-btn');
            
            // Hide existing buttons
            confirmBookingBtn.classList.add('hidden');
            confirmMatchmakingBtn.classList.add('hidden');
            
            // Create or update tournament confirmation button
            let tournamentBtn = document.getElementById('confirm-tournament-btn');
            if (!tournamentBtn) {
                tournamentBtn = document.createElement('button');
                tournamentBtn.id = 'confirm-tournament-btn';
                tournamentBtn.className = 'btn bg-purple-600 text-white w-full hover:bg-purple-700';
                tournamentBtn.innerHTML = `
                    <i class="fa-solid fa-trophy ml-2"></i>
                    تأكيد التسجيل في البطولة
                `;
                tournamentBtn.onclick = confirmTournamentRegistration;
                confirmationSection.appendChild(tournamentBtn);
            }
            
            // Show/hide tournament button based on team readiness
            if (singleTeamPlayers.length >= MIN_TEAM_SIZE && singleTeamPlayers.some(p => p.user_id == loggedInUserId)) {
                tournamentBtn.classList.remove('hidden');
            } else {
                tournamentBtn.classList.add('hidden');
            }
        }

        async function confirmTournamentRegistration() {
            if (!confirm('هل أنت متأكد من تأكيد التسجيل في البطولة؟')) return;
            
            const confirmBtn = document.getElementById('confirm-tournament-btn');
            const originalHtml = confirmBtn.innerHTML;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin ml-2"></i> جاري التأكيد...`;
            
            try {
                showMessageBox('تم التسجيل!', 'تم تسجيل فريقك في البطولة بنجاح. ستتمكن من رؤية التفاصيل في لوحة التحكم الخاصة بك.', 'success');
                
                // Clear tournament data from localStorage
                localStorage.removeItem('tournamentId');
                localStorage.removeItem('registrationType');
                
                // Redirect to dashboard after 3 seconds
                setTimeout(() => {
                    window.location.href = 'user-dashboard.html';
                }, 3000);
                
            } catch (error) {
                console.error('Error confirming tournament registration:', error);
                showMessageBox('خطأ في التأكيد', error.message);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalHtml;
            }
        }

        function copyLink() {
            const invitationLink = document.getElementById('invitation-link');
            invitationLink.select();
            invitationLink.setSelectionRange(0, 99999);
            document.execCommand('copy');
            showMessageBox('تم النسخ!', 'تم نسخ رابط الدعوة بنجاح.', 'success');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', loadOrCreateTeam);

        // Cleanup polling on page unload
        window.addEventListener('beforeunload', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    </script>
</body>
</html>
